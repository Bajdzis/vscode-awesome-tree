<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="{{basePath}}/style.css">
    <script src="{{basePath}}/script.js"></script>
    {{templates}}
    <template id="field-template">
        <blockquote class="panel" >
            <p class="panel__text">
                <div class="field">
                    <label class="field__label" for="{{name}}" style="display:flex;justify-content: space-between;">
                        <b style="font-size:1.5rem">{{title}}</b> <button class="panel__button button button--primary" data-event="generate-single" data-id="{{id}}">Generate single file</button>
                    </label>
                    <pre class="field__code">{{code}}</pre>
                </div>
            </p>
        </blockquote>
    </template>
    
    <template id="title-template">
        <h2 style="display:flex;justify-content: space-between;">
            <span>{{title}} <span style="font-weight: 400;">( {{count}} )</span></span>
            <button class="button button--primary" data-event="generate-all">Generate all</button>
        </h2>
    </template>
    <title>Choose files to create</title>
</head>

<body>
    <div class="container">
        <h1>Choose files to create</h1>
        <p id="forDirectory"></p>
        <ul class="tab" id="tabs">
        </ul>

        <div id="fields" data-type="none"></div>

        
    </div>

    <script>
        const vscode = acquireVsCodeApi();
        const initialState = {
            createdFolderName: "",
            allSiblingHave: [],
            notAllSiblingHave: [],
            fromTemplate: [],
        };
        let state = vscode.getState() || initialState;

        const setState = (newState) => {
            state = {
                ...state,
                ...newState,
            };
            refreshView(state);
            vscode.setState(state);
        };


        const generateFile = (key, index) => {
            const payload = state[key][index];
            if (!state[key][index].generated) {
                vscode.postMessage({
                    type: 'GENERATE_FILE',
                    payload: {...payload}
                });
            }
            state[key][index].generated = true;
            setState(state);
        }

        const generateGroup = (title, key, container) => {
            const items = state[key];
            const generatedAll = items.every((item) => item.generated);
            if (items.length === 0) {
                return;
            }
            const header = renderTitle({
                title,
                count: items.length
            });
            const headerButton = header.querySelector('button')
            
            if (generatedAll) {
                headerButton.style.display = "none";
            } else {
                headerButton.addEventListener("click", () => {
                    items.forEach((_, index) => {
                        generateFile(key, index);
                    });
                })
            }

            container.appendChild(header);
            items.forEach(({ filePath, filePathTemplate, content, fromTemplate, generated, relativePath }, index) => {
                const fieldElement = renderFile({
                    title: relativePath,
                    code: content,
                    id: index,
                    generated: !!generated
                });
                const button = fieldElement.querySelector('button');
                button && button.addEventListener("click", () => {
                    generateFile(key, index);
                })
                container.appendChild(fieldElement);
            });
        }

        const refreshView = state => {
            const fields = document.querySelector('#fields');
            while (fields.firstChild) {
                fields.firstChild.remove();
            }

            generateGroup("From saved templates", "fromTemplate", fields);
            generateGroup("Always created in sibling directory", "allSiblingHave", fields);
            generateGroup("Others", "notAllSiblingHave", fields);

            document.querySelector('#forDirectory').innerHTML = `For new "<b>${state.createdFolderName}</b>" directory`;
        }

        refreshView(state);

        window.addEventListener('message', ({data}) => { 
            if (data.type === 'SET_DATA') {
                const { allSiblingHave, notAllSiblingHave, fromTemplate, createdFolderName } = data.payload;
                setState({ allSiblingHave, notAllSiblingHave, fromTemplate, createdFolderName })
            }
        })
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="{{basePath}}/style.css">
    <script src="{{basePath}}/script.js"></script>
    {{templates}}
    <title>Choose files to create</title>
</head>

<body>
    <div class="container">
        <h1>Choose files to create</h1>
        <p id="forDirectory"></p>
        <ul class="tab" id="tabs">
        </ul>

        <div id="fields" data-type="none"></div>

        <footer class="footer">
            If you like this extension, show it to your friends!
            <a href="https://github.com/Bajdzis/vscode-awesome-tree">Give a star on github</a>, 
            <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fmarketplace.visualstudio.com%2Fitems%3FitemName%3Dbajdzis.awesome-tree&t=Awesome%20extension!">share on facebook</a> or
            <a href="https://twitter.com/share?url=https%3A%2F%2Fmarketplace.visualstudio.com%2Fitems%3FitemName%3Dbajdzis.awesome-tree&text=Awesome%20extension!">share on twitter</a>
        </footer>
    </div>

    <script>
        const vscode = acquireVsCodeApi();
        const initialState = {
            createdFolderName: "",
            allSiblingHave: [],
        };
        let state = vscode.getState() || initialState;

        const setState = (newState) => {
            state = {
                ...state,
                ...newState,
            };
            refreshView(state);
            vscode.setState(state);
        };


        const generateFile = (key, index) => {
            const payload = state[key][index];
            if (!state[key][index].generated) {
                vscode.postMessage({
                    type: 'GENERATE_FILE',
                    payload: {...payload}
                });
            }
            state[key][index].generated = true;
            setState(state);
        }

        const generateGroup = (title, key, container) => {
            const items = state[key];
            const generatedAll = items.every((item) => item.generated);
            if (items.length === 0) {
                return;
            }
            const header = renderTitle({
                title,
                count: items.length
            });
            const headerButton = header.querySelector('button')
            
            if (generatedAll) {
                headerButton.style.display = "none";
            } else {
                headerButton.addEventListener("click", () => {
                    items.forEach((_, index) => {
                        generateFile(key, index);
                    });
                })
            }

            container.appendChild(header);
            items.forEach(({ filePath, filePathTemplate, content, generated, relativePath }, index) => {
                const fieldElement = renderFile({
                    title: relativePath,
                    code: content,
                    id: index,
                    generated: !!generated
                });
                const button = fieldElement.querySelector('button');
                button && button.addEventListener("click", () => {
                    generateFile(key, index);
                })
                container.appendChild(fieldElement);
            });
        }

        const refreshView = state => {
            const fields = document.querySelector('#fields');
            while (fields.firstChild) {
                fields.firstChild.remove();
            }

            generateGroup("Always created in sibling directory", "allSiblingHave", fields);

            document.querySelector('#forDirectory').innerHTML = `For new "<b>${state.createdFolderName}</b>" directory`;
        }

        refreshView(state);

        window.addEventListener('message', ({data}) => { 
            if (data.type === 'SET_DATA') {
                const { allSiblingHave, createdFolderName } = data.payload;

                setState({ allSiblingHave, createdFolderName })
            }
        })
    </script>
</body>
</html>